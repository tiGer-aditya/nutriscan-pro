<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00d084">
    <meta name="description" content="AI-Powered Smart Food Health Scanner with Vision AI">
    
    <title>NutriScan Pro - AI Vision Scanner</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- QuaggaJS for Barcode Scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <!-- Chart.js for Advanced Visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d084;
            --primary-dark: #00a869;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #00d084;
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-card: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a8c9;
            --text-muted: #6b7194;
            --border: #2a2f4a;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #00d084 0%, #00a869 100%);
            --gradient-3: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Background Animation */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15;
            background: 
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 208, 132, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(245, 87, 108, 0.2) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* Header */
        header {
            text-align: center;
            padding: 60px 20px 40px;
            animation: fadeInDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo-icon {
            font-size: 3.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            font-weight: 900;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.03em;
            margin-bottom: 15px;
            text-shadow: 0 0 40px rgba(0, 208, 132, 0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 30px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 20px;
            animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
            position: relative;
            z-index: 20;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            background: var(--gradient-2);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 208, 132, 0.3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        /* Card Styles */
        .card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-2);
        }

        /* Barcode Scanner */
        #barcode-scanner {
            width: 100%;
            max-width: 640px;
            height: 480px;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: black;
            display: none;
        }

        #barcode-scanner.active {
            display: block;
        }

        #barcode-scanner video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid var(--primary);
            border-radius: 20px;
            pointer-events: none;
        }

        .scanner-overlay::before,
        .scanner-overlay::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary);
        }

        .scanner-overlay::before {
            top: -4px;
            left: -4px;
            border-right: none;
            border-bottom: none;
        }

        .scanner-overlay::after {
            bottom: -4px;
            right: -4px;
            border-left: none;
            border-top: none;
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: calc(100% - 2px); }
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 24px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(0, 208, 132, 0.05);
            transform: translateY(-3px);
        }

        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(0, 208, 132, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Input Fields */
        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 18px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        textarea {
            min-height: 140px;
            resize: vertical;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 208, 132, 0.1);
            background: var(--bg-card);
        }

        /* Buttons */
        .btn {
            padding: 18px 40px;
            border: none;
            border-radius: 16px;
            font-family: inherit;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-2);
            color: white;
            box-shadow: 0 8px 25px rgba(0, 208, 132, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 208, 132, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 25px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* Results Section */
        .results {
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }

        /* Cache Status Badge */
        .cache-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 208, 132, 0.1);
            border: 1px solid rgba(0, 208, 132, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .cache-badge.from-cache {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        /* Product Info Header */
        .product-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .product-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Health Score Circle */
        .score-section {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 50px;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .score-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff4757 0%, #ffa502 50%, #00d084 100%);
        }

        .score-circle-wrapper {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 30px;
        }

        .score-circle {
            transform: rotate(-90deg);
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 900;
            font-family: 'Playfair Display', serif;
        }

        .score-label {
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .grade-badge {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1.3rem;
            margin: 20px 0;
            letter-spacing: 0.05em;
        }

        .grade-excellent { background: rgba(0, 208, 132, 0.2); color: var(--success); border: 2px solid var(--success); }
        .grade-good { background: rgba(102, 126, 234, 0.2); color: #667eea; border: 2px solid #667eea; }
        .grade-moderate { background: rgba(255, 165, 2, 0.2); color: var(--warning); border: 2px solid var(--warning); }
        .grade-poor { background: rgba(255, 71, 87, 0.2); color: var(--danger); border: 2px solid var(--danger); }
        .grade-avoid { background: rgba(255, 71, 87, 0.3); color: #ff2f3e; border: 2px solid #ff2f3e; }

        .score-description {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 500px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Section Titles */
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-icon {
            font-size: 2.2rem;
        }

        /* Nutrition Grid */
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nutrition-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nutrition-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 208, 132, 0.2);
        }

        .nutrition-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-2);
        }

        .nutrition-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .nutrition-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .nutrition-unit {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .nutrition-context {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 30px 0;
        }

        /* Ingredients List */
        .ingredients-list {
            list-style: none;
        }

        .ingredient-item {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .ingredient-item:hover {
            transform: translateX(10px);
            border-color: currentColor;
        }

        .ingredient-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .ingredient-content {
            flex: 1;
        }

        .ingredient-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 6px;
        }

        .ingredient-note {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .ingredient-safe {
            background: rgba(0, 208, 132, 0.05);
            color: var(--success);
        }

        .ingredient-warning {
            background: rgba(255, 165, 2, 0.05);
            color: var(--warning);
        }

        .ingredient-danger {
            background: rgba(255, 71, 87, 0.05);
            color: var(--danger);
        }

        /* Health Issues Alert */
        .health-alert {
            background: rgba(255, 71, 87, 0.1);
            border: 2px solid rgba(255, 71, 87, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .alert-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-list {
            list-style: none;
        }

        .alert-item {
            padding: 15px 0;
            display: flex;
            align-items: start;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 71, 87, 0.2);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-icon {
            color: var(--danger);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Change Detection Alert */
        .change-alert {
            background: rgba(255, 165, 2, 0.1);
            border: 2px solid rgba(255, 165, 2, 0.4);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .change-alert-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .change-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .change-version {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
        }

        .version-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .version-score {
            font-size: 2rem;
            font-weight: 800;
        }

        .version-date {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* Alternatives Section */
        .alternatives-section {
            background: linear-gradient(135deg, rgba(0, 208, 132, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 24px;
            padding: 40px;
            margin-top: 30px;
        }

        .alternatives-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .alternatives-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .alternatives-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .alternatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .alternative-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .alternative-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 15px 40px rgba(0, 208, 132, 0.2);
        }

        .alternative-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .alternative-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .alternative-score {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(0, 208, 132, 0.2);
            color: var(--primary);
            border-radius: 20px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .alternative-reason {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* Info Box */
        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 25px;
            border-radius: 16px;
            margin-top: 25px;
        }

        .info-box-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .info-box-content {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Image preview */
        .image-preview-wrapper {
            margin: 20px 0;
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 500px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .card {
                padding: 25px;
            }
            
            .score-circle-wrapper {
                width: 180px;
                height: 180px;
            }
            
            .score-value {
                font-size: 3.5rem;
            }
            
            .nutrition-grid {
                grid-template-columns: 1fr;
            }
            
            .change-comparison {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                flex-direction: column;
            }
        }

        input[type="file"] {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* AI Vision Badge */
        .ai-vision-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">ü§ñ</span>
            </div>
            <h1>NutriScan Pro</h1>
            <p class="subtitle">AI Vision-Powered Food Health Scanner</p>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="statsProducts">0</div>
                    <div class="stat-label">Products Scanned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsCache">0%</div>
                    <div class="stat-label">Cache Hit Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsTime">0ms</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="image">
                <span>ü§ñ</span> AI Vision Scan
            </button>
            <button class="tab-btn" data-tab="barcode">
                <span>üì∑</span> Barcode
            </button>
            <button class="tab-btn" data-tab="manual">
                <span>‚å®Ô∏è</span> Manual
            </button>
        </div>

        <!-- AI Vision Image Upload Tab -->
        <div class="tab-content active" id="tab-image">
            <div class="card">
                <div class="ai-vision-badge">
                    <span>‚ú®</span> Powered by Claude Vision AI
                </div>
                
                <h2 class="section-title">
                    <span class="section-icon">ü§ñ</span>
                    AI-Powered Label Scanner
                </h2>
                
                <div class="info-box" style="margin-bottom: 20px;">
                    <div class="info-box-title">
                        <span>üß†</span> How AI Vision Works
                    </div>
                    <div class="info-box-content">
                        Upload a photo of any food label, and Claude AI will automatically read and extract all ingredients, nutritional values, and product details. No manual typing required!
                    </div>
                </div>
                
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Upload Food Label Image</div>
                    <div class="upload-subtext">AI will automatically extract ingredients ‚Ä¢ Drag & drop or click</div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <div id="imagePreviewContainer" class="hidden">
                    <div class="image-preview-wrapper">
                        <img id="imagePreview" class="image-preview" alt="Uploaded label">
                        <div>
                            <button class="btn btn-primary" id="analyzeImageBtn">
                                <span>ü§ñ</span> Analyze with AI Vision
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barcode Scanner Tab -->
        <div class="tab-content" id="tab-barcode">
            <div class="card">
                <h2 class="section-title">
                    <span class="section-icon">üì∑</span>
                    Scan Product Barcode
                </h2>
                <div class="info-box" style="margin-bottom: 20px;">
                    <div class="info-box-title">
                        <span>‚ÑπÔ∏è</span> Camera Access Required
                    </div>
                    <div class="info-box-content">
                        This feature requires camera permission and HTTPS (or localhost). Click "Start Scanner" and allow camera access when prompted.
                    </div>
                </div>
                <div id="barcode-scanner">
                    <video></video>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" id="startScanBtn">
                        <span>üì∏</span> Start Barcode Scanner
                    </button>
                    <button class="btn btn-secondary hidden" id="stopScanBtn">
                        <span>‚èπÔ∏è</span> Stop Scanner
                    </button>
                </div>
                <div id="barcodeResult" class="info-box hidden" style="margin-top: 20px;">
                    <div class="info-box-title">
                        <span>‚úÖ</span> Barcode Detected
                    </div>
                    <div class="info-box-content">
                        <strong>Barcode:</strong> <span id="barcodeValue"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Tab -->
        <div class="tab-content" id="tab-manual">
            <div class="card">
                <div class="input-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" placeholder="e.g., Parle Monaco Biscuits">
                </div>

                <div class="input-group">
                    <label for="productSize">Package Size:</label>
                    <input type="text" id="productSize" placeholder="e.g., 120g">
                </div>

                <div class="input-group">
                    <label for="barcode">Barcode (Optional):</label>
                    <input type="text" id="barcode" placeholder="e.g., 1234567890123">
                </div>

                <div class="input-group">
                    <label for="ingredients">Ingredients:</label>
                    <textarea id="ingredients" placeholder="Example: Maida (refined wheat flour), Sugar (35%), Refined palm oil, Edible common salt, Raising agents (503, 500), Emulsifier (322 from soybean), Milk solids, Artificial flavouring substances (vanilla)"></textarea>
                </div>

                <button class="btn btn-primary btn-full" id="analyzeBtn">
                    <span>üîç</span> Analyze Food Product
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">AI Vision Processing...</div>
            <div class="loading-subtext">Extracting ingredients and analyzing nutrition</div>
        </div>

        <!-- Results Section -->
        <div class="results" id="results">
            <!-- Results will be dynamically inserted here -->
        </div>
    </div>

    <script>
        // ========================================
        // DATABASE & CACHE MANAGEMENT
        // ========================================
        
        class ProductDatabase {
            constructor() {
                this.storageKey = 'nutriscan_products';
                this.statsKey = 'nutriscan_stats';
                this.products = this.loadFromStorage();
                this.stats = this.loadStats();
            }

            loadFromStorage() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : {};
                } catch (e) {
                    console.error('Error loading from storage:', e);
                    return {};
                }
            }

            loadStats() {
                try {
                    const data = localStorage.getItem(this.statsKey);
                    return data ? JSON.parse(data) : {
                        totalScans: 0,
                        cacheHits: 0,
                        totalResponseTime: 0,
                        productsInDatabase: 0
                    };
                } catch (e) {
                    console.error('Error loading stats:', e);
                    return {
                        totalScans: 0,
                        cacheHits: 0,
                        totalResponseTime: 0,
                        productsInDatabase: 0
                    };
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.products));
                    localStorage.setItem(this.statsKey, JSON.stringify(this.stats));
                    this.updateStatsDisplay();
                } catch (e) {
                    console.error('Error saving to storage:', e);
                }
            }

            generateProductId(barcode, name, size) {
                return barcode || `${name}_${size}`.toLowerCase().replace(/\s+/g, '_');
            }

            findProduct(productId) {
                return this.products[productId];
            }

            saveProduct(productId, data) {
                if (!this.products[productId]) {
                    this.products[productId] = {
                        id: productId,
                        name: data.name,
                        barcode: data.barcode,
                        variants: [],
                        changeHistory: []
                    };
                    this.stats.productsInDatabase++;
                }

                const product = this.products[productId];
                const variant = product.variants.find(v => v.size === data.size);

                if (variant) {
                    const changes = this.detectChanges(variant, data);
                    if (changes.length > 0) {
                        product.changeHistory.push({
                            date: new Date().toISOString(),
                            changes: changes,
                            oldScore: variant.healthScore,
                            newScore: data.healthScore
                        });
                        variant.previousVersion = { ...variant };
                    }
                    
                    Object.assign(variant, {
                        ...data,
                        lastScanned: new Date().toISOString(),
                        scanCount: (variant.scanCount || 0) + 1
                    });
                } else {
                    product.variants.push({
                        ...data,
                        lastScanned: new Date().toISOString(),
                        scanCount: 1
                    });
                }

                this.saveToStorage();
                return { product, hasChanges: variant && variant.previousVersion };
            }

            detectChanges(oldData, newData) {
                const changes = [];

                if (Math.abs(parseFloat(oldData.nutrition.sugar) - parseFloat(newData.nutrition.sugar)) > 2) {
                    changes.push({
                        type: 'nutrition',
                        field: 'Sugar',
                        old: oldData.nutrition.sugar,
                        new: newData.nutrition.sugar,
                        severity: 'high'
                    });
                }

                if (Math.abs(oldData.healthScore - newData.healthScore) > 10) {
                    changes.push({
                        type: 'score',
                        field: 'Health Score',
                        old: oldData.healthScore,
                        new: newData.healthScore,
                        severity: 'high'
                    });
                }

                return changes;
            }

            recordScan(fromCache, responseTime) {
                this.stats.totalScans++;
                if (fromCache) {
                    this.stats.cacheHits++;
                }
                this.stats.totalResponseTime += responseTime;
                this.saveToStorage();
            }

            updateStatsDisplay() {
                document.getElementById('statsProducts').textContent = this.stats.productsInDatabase;
                const hitRate = this.stats.totalScans > 0 
                    ? Math.round((this.stats.cacheHits / this.stats.totalScans) * 100) 
                    : 0;
                document.getElementById('statsCache').textContent = hitRate + '%';
                const avgTime = this.stats.totalScans > 0
                    ? Math.round(this.stats.totalResponseTime / this.stats.totalScans)
                    : 0;
                document.getElementById('statsTime').textContent = avgTime + 'ms';
            }
        }

        const db = new ProductDatabase();
        db.updateStatsDisplay();

        // ========================================
        // TAB NAVIGATION
        // ========================================
        
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
            });
        });

        // ========================================
        // AI VISION IMAGE UPLOAD & ANALYSIS
        // ========================================
        
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeImageBtn = document.getElementById('analyzeImageBtn');

        let currentImageBase64 = null;

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleImageUpload(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageUpload(e.target.files[0]);
            }
        });

        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageBase64 = e.target.result;
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        analyzeImageBtn.addEventListener('click', async () => {
            if (!currentImageBase64) {
                alert('Please upload an image first.');
                return;
            }

            const startTime = Date.now();
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            imagePreviewContainer.classList.add('hidden');

            try {
                // Call Claude API with vision
                const extractedData = await analyzeImageWithAI(currentImageBase64);
                
                const responseTime = Date.now() - startTime;
                
                if (extractedData.error) {
                    throw new Error(extractedData.error);
                }

                // Analyze the extracted text
                const analysis = performAnalysis(extractedData.fullText);
                
                const productId = db.generateProductId(
                    extractedData.barcode || '', 
                    extractedData.productName, 
                    extractedData.size
                );
                
                db.recordScan(false, responseTime);
                
                const saveResult = db.saveProduct(productId, {
                    name: extractedData.productName,
                    size: extractedData.size,
                    barcode: extractedData.barcode || '',
                    ...analysis
                });
                
                displayResults({
                    ...analysis,
                    fromCache: false,
                    responseTime: responseTime,
                    hasChanges: saveResult.hasChanges,
                    changeHistory: saveResult.product.changeHistory,
                    aiExtracted: true
                }, extractedData.productName);
                
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('AI Vision Error:', error);
                document.getElementById('loading').classList.remove('active');
                alert('Error analyzing image with AI. Please try again or use manual entry.\n\nError: ' + error.message);
                imagePreviewContainer.classList.remove('hidden');
            }
        });

        async function analyzeImageWithAI(imageBase64) {
            // Extract base64 data and media type
            const matches = imageBase64.match(/^data:([^;]+);base64,(.+)$/);
            if (!matches) {
                throw new Error('Invalid image format');
            }
            
            const mediaType = matches[1];
            const base64Data = matches[2];

            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "anthropic-version": "2023-06-01"
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "image",
                                    source: {
                                        type: "base64",
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: "text",
                                    text: `Analyze this food product label image and extract ALL information in the following JSON format:

{
  "productName": "exact product name",
  "size": "package size (e.g., 120g, 500ml)",
  "barcode": "barcode number if visible",
  "ingredients": "complete ingredients list as written on label",
  "nutritionPer100g": {
    "energy": "calories in kcal",
    "protein": "protein in grams",
    "carbohydrates": "total carbs in grams",
    "fat": "total fat in grams",
    "sugar": "sugar in grams or percentage"
  }
}

IMPORTANT:
- Extract the complete ingredients list exactly as written
- If sugar percentage is shown (e.g., "Sugar 35%"), extract just the number
- If nutrition info is "per serving", convert to per 100g if possible
- If any field is not visible, use "Not specified"
- Return ONLY valid JSON, no other text`
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            // Extract JSON from response
            const textContent = data.content.find(c => c.type === 'text')?.text || '';
            
            // Try to extract JSON from the response
            let jsonMatch = textContent.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Could not parse AI response');
            }
            
            const extractedData = JSON.parse(jsonMatch[0]);
            
            // Build full text for analysis
            const fullText = `
Product: ${extractedData.productName}
Size: ${extractedData.size}
Ingredients: ${extractedData.ingredients}
Energy: ${extractedData.nutritionPer100g?.energy || 0} kcal
Protein: ${extractedData.nutritionPer100g?.protein || 0} g
Carbohydrate: ${extractedData.nutritionPer100g?.carbohydrates || 0} g
Fat: ${extractedData.nutritionPer100g?.fat || 0} g
Sugar: ${extractedData.nutritionPer100g?.sugar || 0}
            `.trim();
            
            return {
                productName: extractedData.productName || 'Unknown Product',
                size: extractedData.size || '100g',
                barcode: extractedData.barcode,
                fullText: fullText
            };
        }

        // ========================================
        // BARCODE SCANNER
        // ========================================
        
        const barcodeScanner = document.getElementById('barcode-scanner');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const barcodeResult = document.getElementById('barcodeResult');
        const barcodeValue = document.getElementById('barcodeValue');

        let scannerActive = false;

        startScanBtn.addEventListener('click', startBarcodeScanner);
        stopScanBtn.addEventListener('click', stopBarcodeScanner);

        function startBarcodeScanner() {
            scannerActive = true;
            barcodeScanner.classList.add('active');
            startScanBtn.classList.add('hidden');
            stopScanBtn.classList.remove('hidden');
            barcodeResult.classList.add('hidden');

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: "#barcode-scanner",
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: [
                        "ean_reader", 
                        "ean_8_reader", 
                        "code_128_reader", 
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                },
                locate: true,
                locator: {
                    halfSample: true,
                    patchSize: "medium"
                }
            }, function(err) {
                if (err) {
                    console.error('Quagga initialization error:', err);
                    let errorMsg = 'Camera access error. ';
                    if (err.name === 'NotAllowedError') {
                        errorMsg += 'Please allow camera permission in your browser settings.';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg += 'No camera found on this device.';
                    } else if (err.name === 'NotSupportedError') {
                        errorMsg += 'Camera access requires HTTPS or localhost.';
                    } else {
                        errorMsg += err.message || 'Unknown error occurred.';
                    }
                    alert(errorMsg);
                    stopBarcodeScanner();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if (scannerActive && result.codeResult.code) {
                    const code = result.codeResult.code;
                    barcodeValue.textContent = code;
                    barcodeResult.classList.remove('hidden');
                    
                    setTimeout(() => {
                        stopBarcodeScanner();
                        analyzeByBarcode(code);
                    }, 1000);
                }
            });
        }

        function stopBarcodeScanner() {
            scannerActive = false;
            Quagga.stop();
            barcodeScanner.classList.remove('active');
            stopScanBtn.classList.add('hidden');
            startScanBtn.classList.remove('hidden');
        }

        function analyzeByBarcode(barcode) {
            const startTime = Date.now();
            const cachedProduct = db.findProduct(barcode);
            
            if (cachedProduct && cachedProduct.variants.length > 0) {
                const variant = cachedProduct.variants[0];
                const responseTime = Date.now() - startTime;
                db.recordScan(true, responseTime);
                
                displayResults({
                    ...variant,
                    fromCache: true,
                    responseTime: responseTime
                }, cachedProduct.name);
                
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            } else {
                document.getElementById('loading').classList.add('active');
                
                setTimeout(() => {
                    const mockData = generateMockAnalysis(barcode);
                    const responseTime = Date.now() - startTime;
                    db.recordScan(false, responseTime);
                    
                    const productId = db.generateProductId(barcode, mockData.name, mockData.size);
                    const saveResult = db.saveProduct(productId, {
                        ...mockData,
                        barcode: barcode
                    });
                    
                    displayResults({
                        ...mockData,
                        fromCache: false,
                        responseTime: responseTime,
                        hasChanges: saveResult.hasChanges,
                        changeHistory: saveResult.product.changeHistory
                    }, mockData.name);
                    
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('results').classList.add('active');
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                }, 2000);
            }
        }

        function generateMockAnalysis(barcode) {
            return {
                name: "Sample Product " + barcode.slice(-4),
                size: "120g",
                barcode: barcode,
                healthScore: 35,
                grade: 'D - Poor',
                gradeClass: 'poor',
                description: 'Unhealthy - consider alternatives',
                nutrition: {
                    calories: '469',
                    protein: '5.9',
                    carbs: '72.3',
                    fat: '17.9',
                    sugar: '35'
                },
                badIngredients: [
                    { name: 'Refined Palm Oil', note: 'High in saturated fats', severity: 'danger' },
                    { name: 'High Sugar Content', note: '35% sugar content', severity: 'danger' },
                    { name: 'Maida', note: 'Refined flour, high glycemic index', severity: 'warning' }
                ],
                issues: [
                    'High sugar content - leads to obesity and diabetes',
                    'Refined palm oil increases bad cholesterol',
                    'Artificial colors may cause hyperactivity'
                ]
            };
        }

        // ========================================
        // MANUAL ENTRY & ANALYSIS
        // ========================================
        
        const analyzeBtn = document.getElementById('analyzeBtn');
        const productNameInput = document.getElementById('productName');
        const productSizeInput = document.getElementById('productSize');
        const barcodeInput = document.getElementById('barcode');
        const ingredientsInput = document.getElementById('ingredients');

        analyzeBtn.addEventListener('click', () => {
            const ingredients = ingredientsInput.value.trim();
            const productName = productNameInput.value.trim() || 'Unknown Product';
            const productSize = productSizeInput.value.trim() || '100g';
            const barcode = barcodeInput.value.trim();

            if (!ingredients) {
                alert('Please enter ingredients or upload an image.');
                return;
            }

            analyzeFood(ingredients, productName, productSize, barcode);
        });

        function analyzeFood(ingredientsText, productName, productSize, barcode) {
            const startTime = Date.now();
            const productId = db.generateProductId(barcode, productName, productSize);
            
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');

            const cachedProduct = db.findProduct(productId);
            const cachedVariant = cachedProduct?.variants.find(v => v.size === productSize);

            if (cachedVariant) {
                const responseTime = Date.now() - startTime;
                db.recordScan(true, responseTime);
                
                displayResults({
                    ...cachedVariant,
                    fromCache: true,
                    responseTime: responseTime
                }, productName);
                
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            } else {
                setTimeout(() => {
                    const analysis = performAnalysis(ingredientsText);
                    const responseTime = Date.now() - startTime;
                    db.recordScan(false, responseTime);
                    
                    const saveResult = db.saveProduct(productId, {
                        name: productName,
                        size: productSize,
                        barcode: barcode,
                        ...analysis
                    });
                    
                    displayResults({
                        ...analysis,
                        fromCache: false,
                        responseTime: responseTime,
                        hasChanges: saveResult.hasChanges,
                        changeHistory: saveResult.product.changeHistory
                    }, productName);
                    
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('results').classList.add('active');
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                }, 1500);
            }
        }

        function performAnalysis(text) {
            const lowerText = text.toLowerCase();
            
            let score = 100;
            const issues = [];
            const badIngredients = [];
            
            const sugarMatch = text.match(/sugar[s]?\s*[:\(]?\s*(\d+\.?\d*)%?/i);
            const sugarContent = sugarMatch ? parseFloat(sugarMatch[1]) : 0;
            
            const checks = [
                { 
                    keywords: ['refined palm oil', 'palm oil', 'hydrogenated oil', 'partially hydrogenated'], 
                    penalty: 15, 
                    issue: 'High in saturated fats - increases bad cholesterol and heart disease risk',
                    ingredient: 'Refined Palm Oil / Hydrogenated Oil',
                    note: 'High in saturated fats, linked to cardiovascular issues',
                    severity: 'danger'
                },
                { 
                    keywords: ['maida', 'refined wheat flour', 'refined flour', 'all-purpose flour'], 
                    penalty: 12, 
                    issue: 'Refined flour spikes blood sugar quickly - increases diabetes risk',
                    ingredient: 'Maida (Refined Wheat Flour)',
                    note: 'High glycemic index, low in fiber and nutrients',
                    severity: 'danger'
                },
                { 
                    keywords: ['sunset yellow', 'tartrazine', 'carmoisine', 'erythrosine', 'artificial color', 'artificial colour', 'e102', 'e110', 'e122', 'e124'], 
                    penalty: 10, 
                    issue: 'Artificial colors may cause hyperactivity in children and allergic reactions',
                    ingredient: 'Artificial Colors',
                    note: 'Synthetic dyes with potential health concerns',
                    severity: 'warning'
                },
                { 
                    keywords: ['artificial flavouring', 'artificial flavor', 'artificial flavour'], 
                    penalty: 8, 
                    issue: 'Artificial flavors provide no nutritional value',
                    ingredient: 'Artificial Flavoring',
                    note: 'Synthetic additives with zero nutritional benefit',
                    severity: 'warning'
                },
                { 
                    keywords: ['mono and diglycerides', 'emulsifiers', 'e471', 'e472'], 
                    penalty: 5, 
                    issue: 'Emulsifiers may affect gut bacteria and inflammation',
                    ingredient: 'Emulsifiers',
                    note: 'May impact gut microbiome',
                    severity: 'warning'
                },
                {
                    keywords: ['high fructose corn syrup', 'hfcs', 'corn syrup'],
                    penalty: 16,
                    issue: 'High fructose corn syrup linked to obesity and metabolic syndrome',
                    ingredient: 'High Fructose Corn Syrup',
                    note: 'Highly processed sweetener, worse than regular sugar',
                    severity: 'danger'
                },
                {
                    keywords: ['msg', 'monosodium glutamate', 'e621'],
                    penalty: 7,
                    issue: 'MSG may cause headaches and other reactions in sensitive individuals',
                    ingredient: 'Monosodium Glutamate (MSG)',
                    note: 'Flavor enhancer with potential side effects',
                    severity: 'warning'
                },
                {
                    keywords: ['sodium benzoate', 'potassium benzoate', 'e211', 'e212'],
                    penalty: 6,
                    issue: 'Preservatives that may form benzene (carcinogen) when combined with Vitamin C',
                    ingredient: 'Benzoate Preservatives',
                    note: 'May form harmful compounds in certain conditions',
                    severity: 'warning'
                }
            ];

            const nonVegChecks = [
                {
                    keywords: ['gelatin', 'gelatine', 'pork gelatin', 'beef gelatin'],
                    ingredient: 'Gelatin',
                    note: '‚ö†Ô∏è NON-VEGETARIAN - Derived from animal bones/skin',
                    severity: 'danger'
                },
                {
                    keywords: ['lard', 'animal fat', 'beef fat', 'pork fat'],
                    ingredient: 'Animal Fat/Lard',
                    note: '‚ö†Ô∏è NON-VEGETARIAN - Animal-derived fat',
                    severity: 'danger'
                },
                {
                    keywords: ['carmine', 'cochineal', 'e120'],
                    ingredient: 'Carmine (E120)',
                    note: '‚ö†Ô∏è NON-VEGETARIAN - Red dye from insects',
                    severity: 'danger'
                },
                {
                    keywords: ['fish oil', 'omega-3 fatty acids from fish', 'anchovy'],
                    ingredient: 'Fish-derived Ingredients',
                    note: '‚ö†Ô∏è NON-VEGETARIAN - Contains fish products',
                    severity: 'danger'
                },
                {
                    keywords: ['shellac', 'e904'],
                    ingredient: 'Shellac (E904)',
                    note: '‚ö†Ô∏è NON-VEGETARIAN - Insect-derived coating',
                    severity: 'warning'
                }
            ];

            let hasNonVeg = false;
            nonVegChecks.forEach(check => {
                if (check.keywords.some(keyword => lowerText.includes(keyword))) {
                    score -= 25;
                    issues.push(`Contains non-vegetarian ingredient: ${check.ingredient}`);
                    badIngredients.push({
                        name: check.ingredient,
                        note: check.note,
                        severity: check.severity
                    });
                    hasNonVeg = true;
                }
            });

            checks.forEach(check => {
                if (check.keywords.some(keyword => lowerText.includes(keyword))) {
                    score -= check.penalty;
                    issues.push(check.issue);
                    badIngredients.push({
                        name: check.ingredient,
                        note: check.note,
                        severity: check.severity
                    });
                }
            });

            if (sugarContent > 0) {
                let sugarPenalty = 0;
                let sugarIssue = '';
                
                if (sugarContent >= 40) {
                    sugarPenalty = 25;
                    sugarIssue = `EXTREME sugar content (${sugarContent}%) - Major diabetes and obesity risk`;
                } else if (sugarContent >= 30) {
                    sugarPenalty = 20;
                    sugarIssue = `Very high sugar content (${sugarContent}%) - Leads to obesity, diabetes, and tooth decay`;
                } else if (sugarContent >= 20) {
                    sugarPenalty = 15;
                    sugarIssue = `High sugar content (${sugarContent}%) - Exceeds WHO daily recommendations`;
                } else if (sugarContent >= 10) {
                    sugarPenalty = 10;
                    sugarIssue = `Moderate sugar content (${sugarContent}%) - Consume in moderation`;
                } else if (sugarContent >= 5) {
                    sugarPenalty = 5;
                    sugarIssue = `Low to moderate sugar (${sugarContent}%) - Acceptable levels`;
                }
                
                if (sugarPenalty > 0) {
                    score -= sugarPenalty;
                    if (sugarContent >= 10) {
                        issues.push(sugarIssue);
                        badIngredients.push({
                            name: `High Sugar Content (${sugarContent}%)`,
                            note: `Contains ${sugarContent}g per 100g - ${Math.round((sugarContent / 50) * 100)}% of daily limit`,
                            severity: sugarContent >= 30 ? 'danger' : 'warning'
                        });
                    }
                }
            }

            if (lowerText.includes('trans fat') || lowerText.includes('trans-fat')) {
                score -= 20;
                issues.push('Contains trans fats - extremely harmful to heart health');
                badIngredients.push({
                    name: 'Trans Fats',
                    note: 'Banned in many countries, increases heart disease risk',
                    severity: 'danger'
                });
            }

            score = Math.max(0, score);

            let grade, gradeClass, description;
            if (hasNonVeg) {
                grade = 'F - Contains Non-Veg';
                gradeClass = 'avoid';
                description = '‚ö†Ô∏è Contains animal-derived ingredients - Not suitable for vegetarians';
            } else if (score >= 80) {
                grade = 'A - Excellent';
                gradeClass = 'excellent';
                description = 'This product is a healthy choice!';
            } else if (score >= 60) {
                grade = 'B - Good';
                gradeClass = 'good';
                description = 'Decent choice, consume in moderation';
            } else if (score >= 40) {
                grade = 'C - Moderate';
                gradeClass = 'moderate';
                description = 'Not ideal - limit consumption';
            } else if (score >= 20) {
                grade = 'D - Poor';
                gradeClass = 'poor';
                description = 'Unhealthy - consider alternatives';
            } else {
                grade = 'F - Avoid';
                gradeClass = 'avoid';
                description = 'Highly processed - avoid regular consumption';
            }

            const proteinMatch = text.match(/protein[:\s]+(\d+\.?\d*)\s*g/i);
            const carbsMatch = text.match(/carbohydrate[:\s]+(\d+\.?\d*)\s*g/i);
            const fatMatch = text.match(/fat[:\s]+(\d+\.?\d*)\s*g/i);
            const caloriesMatch = text.match(/energy[:\s]+(\d+)\s*kcal/i);

            return {
                healthScore: score,
                grade,
                gradeClass,
                description,
                issues,
                badIngredients,
                hasNonVeg,
                nutrition: {
                    calories: caloriesMatch ? caloriesMatch[1] : '0',
                    protein: proteinMatch ? proteinMatch[1] : '0',
                    carbs: carbsMatch ? carbsMatch[1] : '0',
                    fat: fatMatch ? fatMatch[1] : '0',
                    sugar: sugarContent.toString()
                }
            };
        }

        // ========================================
        // DISPLAY RESULTS (same as before, with AI badge)
        // ========================================
        
        function displayResults(analysis, productName) {
            const scoreColor = analysis.healthScore >= 60 ? '#00d084' : (analysis.healthScore >= 40 ? '#ffa502' : '#ff4757');
            const circumference = 2 * Math.PI * 105;
            const offset = circumference - (analysis.healthScore / 100) * circumference;

            let cacheBadge = '';
            if (analysis.aiExtracted) {
                cacheBadge = `
                    <div class="ai-vision-badge">
                        <span>ü§ñ</span> Extracted by AI Vision (${analysis.responseTime}ms)
                    </div>
                `;
            } else if (analysis.fromCache) {
                cacheBadge = `
                    <div class="cache-badge from-cache">
                        <span>‚ö°</span> Loaded from cache (${analysis.responseTime}ms)
                    </div>
                `;
            } else {
                cacheBadge = `
                    <div class="cache-badge">
                        <span>üÜï</span> New analysis (${analysis.responseTime}ms)
                    </div>
                `;
            }

            let changeAlert = '';
            if (analysis.hasChanges && analysis.changeHistory && analysis.changeHistory.length > 0) {
                const latestChange = analysis.changeHistory[analysis.changeHistory.length - 1];
                changeAlert = `
                    <div class="change-alert">
                        <div class="change-alert-title">
                            <span>‚ö†Ô∏è</span> Ingredients Changed!
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            This product's formula has been updated since the last scan.
                        </p>
                        <div class="change-comparison">
                            <div class="change-version">
                                <div class="version-label">Previous Version</div>
                                <div class="version-score" style="color: ${latestChange.oldScore >= 60 ? '#00d084' : '#ff4757'}">
                                    Score: ${latestChange.oldScore}
                                </div>
                                <div class="version-date">${new Date(latestChange.date).toLocaleDateString()}</div>
                            </div>
                            <div class="change-version">
                                <div class="version-label">Current Version</div>
                                <div class="version-score" style="color: ${latestChange.newScore >= 60 ? '#00d084' : '#ff4757'}">
                                    Score: ${latestChange.newScore}
                                </div>
                                <div class="version-date">Today</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            const resultsHTML = `
                ${cacheBadge}
                
                <div class="card">
                    <div class="product-header">
                        <div class="product-info">
                            <div class="product-name">${productName}</div>
                            <div class="product-meta">
                                <div class="meta-item">
                                    <span>üì¶</span> ${analysis.size || 'N/A'}
                                </div>
                                ${analysis.barcode ? `
                                <div class="meta-item">
                                    <span>üî¢</span> ${analysis.barcode}
                                </div>
                                ` : ''}
                                <div class="meta-item">
                                    <span>üìÖ</span> ${new Date().toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                ${changeAlert}

                <div class="card score-section">
                    <div class="score-circle-wrapper">
                        <svg width="250" height="250" class="score-circle">
                            <circle cx="125" cy="125" r="105" fill="none" stroke="var(--border)" stroke-width="20"/>
                            <circle cx="125" cy="125" r="105" fill="none" stroke="${scoreColor}" stroke-width="20"
                                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                                    stroke-linecap="round" style="transition: stroke-dashoffset 2s ease-out"/>
                        </svg>
                        <div class="score-value" style="color: ${scoreColor}">${analysis.healthScore}</div>
                    </div>
                    <div class="score-label">Health Score</div>
                    <div class="grade-badge grade-${analysis.gradeClass}">${analysis.grade}</div>
                    <div class="score-description">${analysis.description}</div>
                </div>

                <div class="card">
                    <h2 class="section-title">
                        <span class="section-icon">üìä</span>
                        Nutritional Breakdown
                    </h2>
                    <div class="nutrition-grid">
                        <div class="nutrition-card">
                            <div class="nutrition-label">Calories</div>
                            <div class="nutrition-value">${analysis.nutrition.calories}<span class="nutrition-unit">kcal</span></div>
                            <div class="nutrition-context">Per 100g serving</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Protein</div>
                            <div class="nutrition-value">${analysis.nutrition.protein}<span class="nutrition-unit">g</span></div>
                            <div class="nutrition-context">Essential for muscles</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Carbohydrates</div>
                            <div class="nutrition-value">${analysis.nutrition.carbs}<span class="nutrition-unit">g</span></div>
                            <div class="nutrition-context">Energy source</div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Total Fat</div>
                            <div class="nutrition-value">${analysis.nutrition.fat}<span class="nutrition-unit">g</span></div>
                            <div class="nutrition-context">Check quality matters</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="nutritionChart"></canvas>
                    </div>

                    <div class="info-box">
                        <div class="info-box-title">
                            <span>üí°</span> Daily Context
                        </div>
                        <div class="info-box-content">
                            This product contains <strong>${analysis.nutrition.sugar}g of sugar per 100g</strong>, which is 
                            <strong>${Math.round((parseFloat(analysis.nutrition.sugar) / 50) * 100)}%</strong> of the WHO recommended daily limit (50g). 
                            ${parseFloat(analysis.nutrition.sugar) > 25 ? 'This is very high!' : 'Moderate sugar content.'}
                        </div>
                    </div>
                </div>

                ${analysis.badIngredients && analysis.badIngredients.length > 0 ? `
                <div class="card">
                    <h2 class="section-title">
                        <span class="section-icon">‚ö†Ô∏è</span>
                        Concerning Ingredients
                    </h2>
                    <ul class="ingredients-list">
                        ${analysis.badIngredients.map(ing => `
                            <li class="ingredient-item ingredient-${ing.severity}">
                                <span class="ingredient-icon">${ing.severity === 'danger' ? 'üî¥' : 'üü°'}</span>
                                <div class="ingredient-content">
                                    <div class="ingredient-name">${ing.name}</div>
                                    <div class="ingredient-note">${ing.note}</div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                ${analysis.issues && analysis.issues.length > 0 ? `
                <div class="card">
                    <h2 class="section-title">
                        <span class="section-icon">üè•</span>
                        Health Risks
                    </h2>
                    <div class="health-alert">
                        <div class="alert-title">
                            <span>‚ö†Ô∏è</span> Potential Health Issues
                        </div>
                        <ul class="alert-list">
                            ${analysis.issues.map(issue => `
                                <li class="alert-item">
                                    <span class="alert-icon">‚ö†Ô∏è</span>
                                    <div>${issue}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}

                ${analysis.healthScore < 70 ? `
                <div class="card">
                    <div class="alternatives-section">
                        <div class="alternatives-header">
                            <div class="alternatives-title">üåü Healthier Alternatives</div>
                            <div class="alternatives-subtitle">Better choices for your health</div>
                        </div>
                        <div class="alternatives-grid">
                            <div class="alternative-card">
                                <div class="alternative-icon">üç™</div>
                                <div class="alternative-name">Whole Wheat Cookies</div>
                                <div class="alternative-score">Score: 75-85</div>
                                <div class="alternative-reason">
                                    Made with whole grains, lower sugar content, no refined flour
                                </div>
                            </div>
                            <div class="alternative-card">
                                <div class="alternative-icon">ü•ú</div>
                                <div class="alternative-name">Nut-Based Bars</div>
                                <div class="alternative-score">Score: 80-90</div>
                                <div class="alternative-reason">
                                    High protein, healthy fats, natural sweeteners like dates
                                </div>
                            </div>
                            <div class="alternative-card">
                                <div class="alternative-icon">üçé</div>
                                <div class="alternative-name">Fresh Fruits</div>
                                <div class="alternative-score">Score: 90-95</div>
                                <div class="alternative-reason">
                                    Natural sugars, vitamins, minerals, and fiber
                                </div>
                            </div>
                            <div class="alternative-card">
                                <div class="alternative-icon">üåæ</div>
                                <div class="alternative-name">Homemade Oat Cookies</div>
                                <div class="alternative-score">Score: 75-85</div>
                                <div class="alternative-reason">
                                    Control ingredients, use natural sweeteners, add nuts
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('results').innerHTML = resultsHTML;
            createNutritionChart(analysis.nutrition);
        }

        function createNutritionChart(nutrition) {
            const ctx = document.getElementById('nutritionChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat', 'Sugar'],
                    datasets: [{
                        label: 'Grams per 100g',
                        data: [
                            parseFloat(nutrition.protein),
                            parseFloat(nutrition.carbs),
                            parseFloat(nutrition.fat),
                            parseFloat(nutrition.sugar)
                        ],
                        backgroundColor: [
                            'rgba(0, 208, 132, 0.5)',
                            'rgba(102, 126, 234, 0.5)',
                            'rgba(255, 165, 2, 0.5)',
                            'rgba(255, 71, 87, 0.5)'
                        ],
                        borderColor: [
                            'rgba(0, 208, 132, 1)',
                            'rgba(102, 126, 234, 1)',
                            'rgba(255, 165, 2, 1)',
                            'rgba(255, 71, 87, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a0a8c9'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0a8c9',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        console.log('‚úÖ NutriScan Pro with AI Vision initialized!');
        console.log('ü§ñ Features: Claude Vision AI, Barcode Scanner, Manual Entry');
    </script>
</body>
</html>
