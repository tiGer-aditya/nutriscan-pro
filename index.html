<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#00d084">
    <meta name="description" content="Free Food Health Scanner - Scan barcodes to check nutrition">
    
    <title>NutriScan Pro - Free Food Scanner</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- QuaggaJS for Barcode Scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <!-- Chart.js for Visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00d084;
            --primary-dark: #00a869;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #00d084;
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-card: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a8c9;
            --text-muted: #6b7194;
            --border: #2a2f4a;
            --gradient-2: linear-gradient(135deg, #00d084 0%, #00a869 100%);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15;
            background: 
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 208, 132, 0.3) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.1); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        header {
            text-align: center;
            padding: 60px 20px 40px;
            animation: fadeInDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .logo-icon {
            font-size: 3.5rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 900;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.03em;
            margin-bottom: 15px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 30px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            background: var(--gradient-2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .tab-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 20px;
            animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s both;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            background: var(--gradient-2);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 208, 132, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s both;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-2);
        }

        #barcode-scanner {
            width: 100%;
            max-width: 640px;
            height: 480px;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: black;
            display: none;
        }

        #barcode-scanner.active {
            display: block;
        }

        #barcode-scanner video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid var(--primary);
            border-radius: 20px;
            pointer-events: none;
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: calc(100% - 2px); }
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 18px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        textarea {
            min-height: 140px;
            resize: vertical;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 208, 132, 0.1);
            background: var(--bg-card);
        }

        .btn {
            padding: 18px 40px;
            border: none;
            border-radius: 16px;
            font-family: inherit;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-2);
            color: white;
            box-shadow: 0 8px 25px rgba(0, 208, 132, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 208, 132, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-full {
            width: 100%;
            justify-content: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px;
        }

        .loading.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 25px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .info-box-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .info-box-content {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .cache-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 208, 132, 0.1);
            border: 1px solid rgba(0, 208, 132, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .cache-badge.from-cache {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        .product-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .product-name {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .product-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .product-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .score-section {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 50px;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .score-circle-wrapper {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 30px;
        }

        .score-circle {
            transform: rotate(-90deg);
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 900;
            font-family: 'Playfair Display', serif;
        }

        .score-label {
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
        }

        .grade-badge {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1.3rem;
            margin: 20px 0;
        }

        .grade-excellent { background: rgba(0, 208, 132, 0.2); color: var(--success); border: 2px solid var(--success); }
        .grade-good { background: rgba(102, 126, 234, 0.2); color: #667eea; border: 2px solid #667eea; }
        .grade-moderate { background: rgba(255, 165, 2, 0.2); color: var(--warning); border: 2px solid var(--warning); }
        .grade-poor { background: rgba(255, 71, 87, 0.2); color: var(--danger); border: 2px solid var(--danger); }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nutrition-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .nutrition-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 208, 132, 0.2);
        }

        .nutrition-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .nutrition-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
        }

        .nutrition-unit {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 30px 0;
        }

        .ingredients-list {
            list-style: none;
        }

        .ingredient-item {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .ingredient-item:hover {
            transform: translateX(10px);
        }

        .ingredient-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .ingredient-content {
            flex: 1;
        }

        .ingredient-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 6px;
        }

        .ingredient-note {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .ingredient-safe {
            background: rgba(0, 208, 132, 0.05);
            color: var(--success);
        }

        .ingredient-warning {
            background: rgba(255, 165, 2, 0.05);
            color: var(--warning);
        }

        .ingredient-danger {
            background: rgba(255, 71, 87, 0.05);
            color: var(--danger);
        }

        .health-alert {
            background: rgba(255, 71, 87, 0.1);
            border: 2px solid rgba(255, 71, 87, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .alert-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-list {
            list-style: none;
        }

        .alert-item {
            padding: 15px 0;
            display: flex;
            align-items: start;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 71, 87, 0.2);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alternatives-section {
            background: linear-gradient(135deg, rgba(0, 208, 132, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
            border: 2px solid rgba(0, 208, 132, 0.3);
            border-radius: 24px;
            padding: 40px;
            margin-top: 30px;
        }

        .alternatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .alternative-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .alternative-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            
            .card {
                padding: 25px;
            }
            
            .score-circle-wrapper {
                width: 180px;
                height: 180px;
            }
            
            .score-value {
                font-size: 3.5rem;
            }
            
            .tab-nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    
    <div class="container">
        <header>
            <div class="logo-icon">ü•ó</div>
            <h1>NutriScan Pro</h1>
            <p class="subtitle">Free Food Health Scanner - Powered by OpenFoodFacts</p>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="statsProducts">0</div>
                    <div class="stat-label">Products Scanned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statsCache">0%</div>
                    <div class="stat-label">Cache Hit Rate</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">2.8M+</div>
                    <div class="stat-label">Database Products</div>
                </div>
            </div>
        </header>

        <div class="tab-nav">
            <button class="tab-btn active" data-tab="barcode">
                <span>üì∑</span> Barcode Scanner
            </button>
            <button class="tab-btn" data-tab="search">
                <span>üîç</span> Search Product
            </button>
            <button class="tab-btn" data-tab="manual">
                <span>‚å®Ô∏è</span> Manual Entry
            </button>
        </div>

        <!-- Barcode Scanner Tab -->
        <div class="tab-content active" id="tab-barcode">
            <div class="card">
                <h2 class="section-title">
                    <span>üì∑</span>
                    Scan Product Barcode
                </h2>
                <div class="info-box">
                    <div class="info-box-title">
                        <span>‚ÑπÔ∏è</span> Scanner Requirements
                    </div>
                    <div class="info-box-content">
                        <strong>‚úÖ Scanner works on:</strong> HTTPS sites, localhost, GitHub Pages<br>
                        <strong>üì± Best on:</strong> Chrome/Safari mobile with good lighting<br>
                        <strong>‚ö†Ô∏è If scanner fails:</strong> Use "Search Product" tab - it works perfectly and has 2.8M+ products!
                    </div>
                </div>
                
                <div class="info-box" style="background: rgba(0, 208, 132, 0.1); border-left-color: var(--primary); margin-bottom: 20px;">
                    <div class="info-box-title" style="color: var(--primary);">
                        <span>üí°</span> Pro Tip
                    </div>
                    <div class="info-box-content">
                        <strong>Scanner not working?</strong> No problem! The <strong>"Search Product"</strong> tab is often faster and easier. Just type the product name (e.g., "Coca Cola", "Nutella") and get instant results from 2.8 million products!
                    </div>
                </div>
                <div id="barcode-scanner">
                    <video></video>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" id="startScanBtn">
                        <span>üì∏</span> Start Scanner
                    </button>
                    <button class="btn btn-secondary hidden" id="stopScanBtn">
                        <span>‚èπÔ∏è</span> Stop Scanner
                    </button>
                    <button class="btn btn-secondary" id="testBarcodeBtn" style="margin-left: 10px;">
                        <span>üß™</span> Test with Sample
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 15px; color: var(--text-muted); font-size: 0.9rem;">
                    <strong>Scanner not working?</strong> Click "Test with Sample" or use <span style="color: var(--primary); cursor: pointer; text-decoration: underline;" onclick="document.querySelector('[data-tab=search]').click()">Search Product</span> tab
                </div>
                <div id="barcodeResult" class="info-box hidden" style="margin-top: 20px;">
                    <div class="info-box-title">
                        <span>‚úÖ</span> Barcode Detected
                    </div>
                    <div class="info-box-content">
                        <strong>Barcode:</strong> <span id="barcodeValue"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Tab -->
        <div class="tab-content" id="tab-search">
            <div class="card">
                <h2 class="section-title">
                    <span>üîç</span>
                    Search Product by Name
                </h2>
                <div class="input-group">
                    <label for="searchQuery">Product Name:</label>
                    <input type="text" id="searchQuery" placeholder="e.g., Coca Cola, Nutella, Maggi">
                </div>
                <button class="btn btn-primary btn-full" id="searchBtn">
                    <span>üîç</span> Search Product
                </button>
                
                <div id="searchResults" class="hidden" style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-secondary);">Search Results:</h3>
                    <div id="searchResultsList"></div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Tab -->
        <div class="tab-content" id="tab-manual">
            <div class="card">
                <div class="input-group">
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" placeholder="e.g., Parle Monaco Biscuits">
                </div>

                <div class="input-group">
                    <label for="ingredients">Ingredients:</label>
                    <textarea id="ingredients" placeholder="Example: Maida (refined wheat flour), Sugar (35%), Refined palm oil, Salt, Raising agents (503, 500)..."></textarea>
                </div>

                <button class="btn btn-primary btn-full" id="analyzeBtn">
                    <span>üîç</span> Analyze Ingredients
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Fetching product data...</div>
        </div>

        <!-- Results Section -->
        <div class="results" id="results"></div>
    </div>

    <script>
        // ========================================
        // DATABASE & CACHE
        // ========================================
        
        class ProductDatabase {
            constructor() {
                this.storageKey = 'nutriscan_products';
                this.statsKey = 'nutriscan_stats';
                this.products = this.loadFromStorage();
                this.stats = this.loadStats();
            }

            loadFromStorage() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : {};
                } catch (e) {
                    return {};
                }
            }

            loadStats() {
                try {
                    const data = localStorage.getItem(this.statsKey);
                    return data ? JSON.parse(data) : {
                        totalScans: 0,
                        cacheHits: 0,
                        productsInDatabase: 0
                    };
                } catch (e) {
                    return { totalScans: 0, cacheHits: 0, productsInDatabase: 0 };
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.products));
                    localStorage.setItem(this.statsKey, JSON.stringify(this.stats));
                    this.updateStatsDisplay();
                } catch (e) {
                    console.error('Storage error:', e);
                }
            }

            findProduct(barcode) {
                return this.products[barcode];
            }

            saveProduct(barcode, data) {
                if (!this.products[barcode]) {
                    this.stats.productsInDatabase++;
                }
                
                this.products[barcode] = {
                    ...data,
                    lastScanned: new Date().toISOString(),
                    scanCount: (this.products[barcode]?.scanCount || 0) + 1
                };
                
                this.saveToStorage();
            }

            recordScan(fromCache) {
                this.stats.totalScans++;
                if (fromCache) {
                    this.stats.cacheHits++;
                }
                this.saveToStorage();
            }

            updateStatsDisplay() {
                document.getElementById('statsProducts').textContent = this.stats.productsInDatabase;
                const hitRate = this.stats.totalScans > 0 
                    ? Math.round((this.stats.cacheHits / this.stats.totalScans) * 100) 
                    : 0;
                document.getElementById('statsCache').textContent = hitRate + '%';
            }
        }

        const db = new ProductDatabase();
        db.updateStatsDisplay();

        // ========================================
        // TAB NAVIGATION
        // ========================================
        
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${tabId}`).classList.add('active');
            });
        });

        // ========================================
        // BARCODE SCANNER
        // ========================================
        
        const barcodeScanner = document.getElementById('barcode-scanner');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const barcodeResult = document.getElementById('barcodeResult');
        const barcodeValue = document.getElementById('barcodeValue');

        let scannerActive = false;

        startScanBtn.addEventListener('click', startBarcodeScanner);
        stopScanBtn.addEventListener('click', stopBarcodeScanner);
        
        // Test barcode button - uses popular products for demo
        document.getElementById('testBarcodeBtn').addEventListener('click', () => {
            const testBarcodes = [
                { code: '3017620422003', name: 'Nutella' },
                { code: '5449000000439', name: 'Coca-Cola' },
                { code: '3168930010883', name: 'Ferrero Rocher' },
                { code: '7622210449283', name: 'Milka Chocolate' },
                { code: '8901063310087', name: 'Maggi Noodles' }
            ];
            
            const random = testBarcodes[Math.floor(Math.random() * testBarcodes.length)];
            
            const useTest = confirm(
                `üß™ Test Scanner\n\nThis will load a sample product:\n"${random.name}"\n\nClick OK to test, or Cancel to try a real scan.`
            );
            
            if (useTest) {
                barcodeValue.textContent = random.code;
                barcodeResult.classList.remove('hidden');
                fetchProductByBarcode(random.code);
            }
        });

        async function startBarcodeScanner() {
            // Check if running on HTTPS or localhost
            const isSecure = window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                alert('‚ö†Ô∏è Camera requires HTTPS\n\nBarcode scanner only works on:\n‚úÖ HTTPS websites\n‚úÖ localhost (for testing)\n\nPlease use the "Search Product" tab instead, or deploy to GitHub Pages (HTTPS).');
                return;
            }

            // Request camera permission first
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
            } catch (err) {
                console.error('Camera permission error:', err);
                let errorMsg = 'üì∑ Camera Access Required\n\n';
                
                if (err.name === 'NotAllowedError') {
                    errorMsg += 'Please allow camera permission:\n1. Click üîí in address bar\n2. Allow camera access\n3. Refresh page';
                } else if (err.name === 'NotFoundError') {
                    errorMsg += 'No camera found on this device.\n\nTry:\n‚úÖ Search Product tab\n‚úÖ Manual Entry tab';
                } else if (err.name === 'NotSupportedError') {
                    errorMsg += 'Camera not supported in this browser.\n\nTry:\n‚úÖ Chrome/Safari on mobile\n‚úÖ Search Product tab';
                } else {
                    errorMsg += `Error: ${err.message}\n\nTry:\n‚úÖ Search Product tab\n‚úÖ Manual Entry tab`;
                }
                
                alert(errorMsg);
                return;
            }

            scannerActive = true;
            barcodeScanner.classList.add('active');
            startScanBtn.classList.add('hidden');
            stopScanBtn.classList.remove('hidden');
            barcodeResult.classList.add('hidden');

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector("#barcode-scanner"),
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment",
                        aspectRatio: { min: 1, max: 2 }
                    },
                },
                decoder: {
                    readers: [
                        "ean_reader",
                        "ean_8_reader",
                        "code_128_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: false,
                        drawScanline: true,
                        showPattern: false
                    },
                    multiple: false
                },
                locate: true,
                locator: {
                    halfSample: true,
                    patchSize: "medium",
                    debug: {
                        showCanvas: false,
                        showPatches: false,
                        showFoundPatches: false,
                        showSkeleton: false,
                        showLabels: false,
                        showPatchLabels: false,
                        showRemainingPatchLabels: false,
                        boxFromPatches: {
                            showTransformed: false,
                            showTransformedBox: false,
                            showBB: false
                        }
                    }
                },
                numOfWorkers: navigator.hardwareConcurrency || 4,
                frequency: 10,
                area: {
                    top: "20%",
                    right: "10%",
                    left: "10%",
                    bottom: "20%"
                }
            }, function(err) {
                if (err) {
                    console.error('Quagga init error:', err);
                    stopBarcodeScanner();
                    
                    alert('‚ùå Scanner initialization failed\n\nPlease use:\n‚úÖ Search Product tab (works great!)\n‚úÖ Manual Entry tab\n\nError: ' + (err.message || 'Unknown error'));
                    return;
                }
                
                console.log('‚úÖ Scanner started successfully');
                Quagga.start();
            });

            // Use processed detection with quality checking
            let lastDetectedCode = null;
            let detectionCount = 0;
            const REQUIRED_DETECTIONS = 3; // Need 3 consistent detections

            Quagga.onProcessed(function(result) {
                const drawingCtx = Quagga.canvas.ctx.overlay;
                const drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    // Draw detection box
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(box => box !== result.box).forEach(box => {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00d084", lineWidth: 4});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        const code = result.codeResult.code;
                        
                        // Check if it's the same code
                        if (code === lastDetectedCode) {
                            detectionCount++;
                        } else {
                            lastDetectedCode = code;
                            detectionCount = 1;
                        }

                        // Only trigger if we have consistent detections
                        if (scannerActive && detectionCount >= REQUIRED_DETECTIONS) {
                            console.log('Barcode detected with confidence:', code);
                            
                            barcodeValue.textContent = code;
                            barcodeResult.classList.remove('hidden');
                            
                            // Beep sound
                            try {
                                const beep = new AudioContext();
                                const oscillator = beep.createOscillator();
                                oscillator.frequency.value = 800;
                                oscillator.connect(beep.destination);
                                oscillator.start();
                                setTimeout(() => oscillator.stop(), 100);
                            } catch (e) {
                                // Audio not supported, ignore
                            }
                            
                            // Reset detection counters
                            lastDetectedCode = null;
                            detectionCount = 0;
                            
                            setTimeout(() => {
                                stopBarcodeScanner();
                                fetchProductByBarcode(code);
                            }, 500);
                        }
                    }
                }
            });
        }

        function stopBarcodeScanner() {
            scannerActive = false;
            Quagga.stop();
            barcodeScanner.classList.remove('active');
            stopScanBtn.classList.add('hidden');
            startScanBtn.classList.remove('hidden');
        }

        // ========================================
        // OPENFOODFACTS API
        // ========================================
        
        async function fetchProductByBarcode(barcode) {
            // Check cache first
            const cached = db.findProduct(barcode);
            if (cached) {
                db.recordScan(true);
                displayResults(cached, true);
                return;
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');

            try {
                const response = await fetch(
                    `https://world.openfoodfacts.org/api/v2/product/${barcode}.json`
                );
                const data = await response.json();

                if (data.status === 1 && data.product) {
                    const productData = parseOpenFoodFactsData(data.product);
                    db.saveProduct(barcode, productData);
                    db.recordScan(false);
                    displayResults(productData, false);
                } else {
                    alert('‚ùå Product not found in database.\n\nTry:\n‚úÖ Manual Entry tab\n‚úÖ Search by product name');
                    document.getElementById('loading').classList.remove('active');
                }
            } catch (error) {
                console.error('API Error:', error);
                alert('Error fetching product data. Please check your internet connection.');
                document.getElementById('loading').classList.remove('active');
            }
        }

        async function searchProductByName(query) {
            document.getElementById('loading').classList.add('active');
            document.getElementById('searchResults').classList.add('hidden');

            try {
                const response = await fetch(
                    `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1&page_size=10`
                );
                const data = await response.json();

                document.getElementById('loading').classList.remove('active');

                if (data.products && data.products.length > 0) {
                    displaySearchResults(data.products);
                } else {
                    alert('No products found. Try a different search term.');
                }
            } catch (error) {
                console.error('Search Error:', error);
                document.getElementById('loading').classList.remove('active');
                alert('Search error. Please try again.');
            }
        }

        function displaySearchResults(products) {
            const resultsDiv = document.getElementById('searchResultsList');
            resultsDiv.innerHTML = products.map(product => `
                <div class="card" style="cursor: pointer; margin-bottom: 15px;" onclick="selectSearchResult('${product.code}')">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        ${product.image_url ? `<img src="${product.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 12px;">` : '<div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üì¶</div>'}
                        <div style="flex: 1;">
                            <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${product.product_name || 'Unknown Product'}</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">${product.brands || 'Unknown Brand'}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">Barcode: ${product.code}</div>
                        </div>
                        <div style="color: var(--primary); font-weight: 700;">
                            View ‚Üí
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('searchResults').classList.remove('hidden');
        }

        function selectSearchResult(barcode) {
            document.getElementById('searchResults').classList.add('hidden');
            fetchProductByBarcode(barcode);
        }

        function parseOpenFoodFactsData(product) {
            const nutriments = product.nutriments || {};
            
            // Analyze ingredients
            const ingredientsText = product.ingredients_text || '';
            const analysis = performAnalysis(ingredientsText, nutriments);

            return {
                name: product.product_name || 'Unknown Product',
                brand: product.brands || '',
                barcode: product.code,
                image: product.image_url,
                categories: product.categories || '',
                ingredientsText: ingredientsText,
                ...analysis,
                nutrition: {
                    calories: Math.round(nutriments['energy-kcal_100g'] || 0),
                    protein: (nutriments.proteins_100g || 0).toFixed(1),
                    carbs: (nutriments.carbohydrates_100g || 0).toFixed(1),
                    fat: (nutriments.fat_100g || 0).toFixed(1),
                    sugar: (nutriments.sugars_100g || 0).toFixed(1),
                    fiber: (nutriments.fiber_100g || 0).toFixed(1),
                    sodium: (nutriments.sodium_100g || 0).toFixed(3)
                },
                nutriScore: product.nutriscore_grade?.toUpperCase() || null,
                novaGroup: product.nova_group || null
            };
        }

        // ========================================
        // ANALYSIS ENGINE
        // ========================================
        
        function performAnalysis(ingredientsText, nutriments = {}) {
            const lowerText = ingredientsText.toLowerCase();
            let score = 100;
            const issues = [];
            const badIngredients = [];

            // Sugar analysis
            const sugarContent = parseFloat(nutriments.sugars_100g || 0);
            if (sugarContent > 0) {
                if (sugarContent >= 22.5) {
                    score -= 25;
                    issues.push(`Very high sugar content (${sugarContent}g per 100g) - Major health risk`);
                    badIngredients.push({
                        name: `High Sugar (${sugarContent}g)`,
                        note: 'Exceeds WHO recommendations - Risk of diabetes and obesity',
                        severity: 'danger'
                    });
                } else if (sugarContent >= 12.5) {
                    score -= 15;
                    issues.push(`High sugar content (${sugarContent}g per 100g)`);
                    badIngredients.push({
                        name: `Moderate Sugar (${sugarContent}g)`,
                        note: 'Consume in moderation',
                        severity: 'warning'
                    });
                }
            }

            // Sodium analysis
            const sodiumContent = parseFloat(nutriments.sodium_100g || 0);
            if (sodiumContent >= 1.5) {
                score -= 20;
                issues.push(`Very high sodium - Risk of hypertension`);
                badIngredients.push({
                    name: `High Sodium (${(sodiumContent * 1000).toFixed(0)}mg)`,
                    note: 'Excessive salt intake increases blood pressure',
                    severity: 'danger'
                });
            } else if (sodiumContent >= 0.6) {
                score -= 10;
                badIngredients.push({
                    name: `Moderate Sodium (${(sodiumContent * 1000).toFixed(0)}mg)`,
                    note: 'Watch your salt intake',
                    severity: 'warning'
                });
            }

            // Saturated fat analysis
            const satFat = parseFloat(nutriments['saturated-fat_100g'] || 0);
            if (satFat >= 5) {
                score -= 15;
                issues.push('High saturated fat - Increases bad cholesterol');
                badIngredients.push({
                    name: `High Saturated Fat (${satFat}g)`,
                    note: 'Linked to heart disease',
                    severity: 'danger'
                });
            }

            // Harmful ingredients checks
            const harmfulChecks = [
                {
                    keywords: ['palm oil', 'hydrogenated', 'partially hydrogenated'],
                    penalty: 15,
                    name: 'Palm Oil / Hydrogenated Oils',
                    note: 'High in saturated fats, linked to heart disease',
                    issue: 'Contains palm oil or hydrogenated fats',
                    severity: 'danger'
                },
                {
                    keywords: ['refined flour', 'maida', 'refined wheat'],
                    penalty: 12,
                    name: 'Refined Flour (Maida)',
                    note: 'High glycemic index, low nutritional value',
                    issue: 'Refined flour spikes blood sugar',
                    severity: 'warning'
                },
                {
                    keywords: ['artificial color', 'artificial colour', 'tartrazine', 'sunset yellow', 'e102', 'e110', 'e122'],
                    penalty: 10,
                    name: 'Artificial Colors',
                    note: 'Synthetic dyes with potential health concerns',
                    issue: 'Contains artificial colors',
                    severity: 'warning'
                },
                {
                    keywords: ['msg', 'monosodium glutamate', 'e621'],
                    penalty: 8,
                    name: 'MSG (E621)',
                    note: 'Flavor enhancer, may cause reactions in sensitive individuals',
                    issue: 'Contains MSG',
                    severity: 'warning'
                },
                {
                    keywords: ['high fructose corn syrup', 'hfcs'],
                    penalty: 18,
                    name: 'High Fructose Corn Syrup',
                    note: 'Linked to obesity and metabolic issues',
                    issue: 'Contains HFCS - worse than regular sugar',
                    severity: 'danger'
                },
                {
                    keywords: ['aspartame', 'sucralose', 'acesulfame'],
                    penalty: 7,
                    name: 'Artificial Sweeteners',
                    note: 'May affect gut bacteria and metabolism',
                    issue: 'Contains artificial sweeteners',
                    severity: 'warning'
                }
            ];

            harmfulChecks.forEach(check => {
                if (check.keywords.some(kw => lowerText.includes(kw))) {
                    score -= check.penalty;
                    issues.push(check.issue);
                    badIngredients.push({
                        name: check.name,
                        note: check.note,
                        severity: check.severity
                    });
                }
            });

            score = Math.max(0, Math.min(100, score));

            // Grade calculation
            let grade, gradeClass;
            if (score >= 80) {
                grade = 'A - Excellent';
                gradeClass = 'excellent';
            } else if (score >= 60) {
                grade = 'B - Good';
                gradeClass = 'good';
            } else if (score >= 40) {
                grade = 'C - Moderate';
                gradeClass = 'moderate';
            } else {
                grade = 'D - Poor';
                gradeClass = 'poor';
            }

            return {
                healthScore: Math.round(score),
                grade,
                gradeClass,
                issues,
                badIngredients
            };
        }

        // ========================================
        // MANUAL ANALYSIS
        // ========================================
        
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            const ingredients = document.getElementById('ingredients').value.trim();
            const productName = document.getElementById('productName').value.trim() || 'Unknown Product';

            if (!ingredients) {
                alert('Please enter ingredients.');
                return;
            }

            document.getElementById('loading').classList.add('active');
            
            setTimeout(() => {
                const analysis = performAnalysis(ingredients, {});
                const productData = {
                    name: productName,
                    ingredientsText: ingredients,
                    ...analysis,
                    nutrition: {
                        calories: 0,
                        protein: 0,
                        carbs: 0,
                        fat: 0,
                        sugar: 0
                    }
                };
                
                displayResults(productData, false);
                document.getElementById('loading').classList.remove('active');
            }, 500);
        });

        // ========================================
        // SEARCH FUNCTIONALITY
        // ========================================
        
        document.getElementById('searchBtn').addEventListener('click', () => {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                alert('Please enter a product name.');
                return;
            }
            searchProductByName(query);
        });

        document.getElementById('searchQuery').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // ========================================
        // DISPLAY RESULTS
        // ========================================
        
        function displayResults(data, fromCache) {
            const scoreColor = data.healthScore >= 60 ? '#00d084' : (data.healthScore >= 40 ? '#ffa502' : '#ff4757');
            const circumference = 2 * Math.PI * 105;
            const offset = circumference - (data.healthScore / 100) * circumference;

            let cacheBadge = fromCache 
                ? '<div class="cache-badge from-cache"><span>‚ö°</span> Loaded from cache</div>'
                : '<div class="cache-badge"><span>üÜï</span> Fresh data</div>';

            const resultsHTML = `
                ${cacheBadge}
                
                <div class="card">
                    <div class="product-header">
                        <div>
                            <div class="product-name">${data.name}</div>
                            <div class="product-meta">
                                ${data.brand ? `<div>üè∑Ô∏è ${data.brand}</div>` : ''}
                                ${data.barcode ? `<div>üî¢ ${data.barcode}</div>` : ''}
                                ${data.nutriScore ? `<div>üìä Nutri-Score: ${data.nutriScore}</div>` : ''}
                                ${data.novaGroup ? `<div>üî¨ NOVA: ${data.novaGroup}</div>` : ''}
                            </div>
                        </div>
                        ${data.image ? `<img src="${data.image}" class="product-image" alt="${data.name}">` : ''}
                    </div>
                </div>

                <div class="card score-section">
                    <div class="score-circle-wrapper">
                        <svg width="250" height="250" class="score-circle">
                            <circle cx="125" cy="125" r="105" fill="none" stroke="var(--border)" stroke-width="20"/>
                            <circle cx="125" cy="125" r="105" fill="none" stroke="${scoreColor}" stroke-width="20"
                                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                                    stroke-linecap="round" style="transition: stroke-dashoffset 2s ease-out"/>
                        </svg>
                        <div class="score-value" style="color: ${scoreColor}">${data.healthScore}</div>
                    </div>
                    <div class="score-label">Health Score</div>
                    <div class="grade-badge grade-${data.gradeClass}">${data.grade}</div>
                </div>

                <div class="card">
                    <h2 class="section-title">
                        <span>üìä</span>
                        Nutrition Facts
                    </h2>
                    <div class="nutrition-grid">
                        <div class="nutrition-card">
                            <div class="nutrition-label">Energy</div>
                            <div class="nutrition-value">${data.nutrition.calories}<span class="nutrition-unit">kcal</span></div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Protein</div>
                            <div class="nutrition-value">${data.nutrition.protein}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Carbs</div>
                            <div class="nutrition-value">${data.nutrition.carbs}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Fat</div>
                            <div class="nutrition-value">${data.nutrition.fat}<span class="nutrition-unit">g</span></div>
                        </div>
                        <div class="nutrition-card">
                            <div class="nutrition-label">Sugar</div>
                            <div class="nutrition-value">${data.nutrition.sugar}<span class="nutrition-unit">g</span></div>
                        </div>
                        ${data.nutrition.fiber ? `
                        <div class="nutrition-card">
                            <div class="nutrition-label">Fiber</div>
                            <div class="nutrition-value">${data.nutrition.fiber}<span class="nutrition-unit">g</span></div>
                        </div>
                        ` : ''}
                    </div>

                    <div class="chart-container">
                        <canvas id="nutritionChart"></canvas>
                    </div>
                </div>

                ${data.badIngredients && data.badIngredients.length > 0 ? `
                <div class="card">
                    <h2 class="section-title">
                        <span>‚ö†Ô∏è</span>
                        Concerning Ingredients
                    </h2>
                    <ul class="ingredients-list">
                        ${data.badIngredients.map(ing => `
                            <li class="ingredient-item ingredient-${ing.severity}">
                                <span class="ingredient-icon">${ing.severity === 'danger' ? 'üî¥' : 'üü°'}</span>
                                <div class="ingredient-content">
                                    <div class="ingredient-name">${ing.name}</div>
                                    <div class="ingredient-note">${ing.note}</div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                ${data.issues && data.issues.length > 0 ? `
                <div class="card">
                    <div class="health-alert">
                        <div class="alert-title">
                            <span>‚ö†Ô∏è</span> Health Concerns
                        </div>
                        <ul class="alert-list">
                            ${data.issues.map(issue => `
                                <li class="alert-item">
                                    <span style="color: var(--danger);">‚ö†Ô∏è</span>
                                    <div>${issue}</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                ` : ''}

                ${data.healthScore < 70 ? `
                <div class="card">
                    <div class="alternatives-section">
                        <h2 class="section-title" style="justify-content: center; margin-bottom: 20px;">
                            <span>üåü</span>
                            Healthier Alternatives
                        </h2>
                        <div class="alternatives-grid">
                            <div class="alternative-card">
                                <div style="font-size: 3rem; margin-bottom: 15px;">ü•ó</div>
                                <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 10px;">Whole Foods</div>
                                <div style="color: var(--text-secondary);">Choose fresh fruits, vegetables, and whole grains</div>
                            </div>
                            <div class="alternative-card">
                                <div style="font-size: 3rem; margin-bottom: 15px;">üåæ</div>
                                <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 10px;">Whole Wheat Options</div>
                                <div style="color: var(--text-secondary);">Look for 100% whole grain alternatives</div>
                            </div>
                            <div class="alternative-card">
                                <div style="font-size: 3rem; margin-bottom: 15px;">ü•ú</div>
                                <div style="font-weight: 700; font-size: 1.2rem; margin-bottom: 10px;">Nut-Based Snacks</div>
                                <div style="color: var(--text-secondary);">Natural protein and healthy fats</div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${data.ingredientsText ? `
                <div class="card">
                    <h2 class="section-title">
                        <span>üìù</span>
                        Full Ingredients List
                    </h2>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 16px; line-height: 1.8; color: var(--text-secondary);">
                        ${data.ingredientsText}
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('results').innerHTML = resultsHTML;
            document.getElementById('results').classList.add('active');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

            if (data.nutrition) {
                createNutritionChart(data.nutrition);
            }
        }

        function createNutritionChart(nutrition) {
            const ctx = document.getElementById('nutritionChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Protein', 'Carbs', 'Fat', 'Sugar'],
                    datasets: [{
                        label: 'Grams per 100g',
                        data: [
                            parseFloat(nutrition.protein),
                            parseFloat(nutrition.carbs),
                            parseFloat(nutrition.fat),
                            parseFloat(nutrition.sugar)
                        ],
                        backgroundColor: [
                            'rgba(0, 208, 132, 0.5)',
                            'rgba(102, 126, 234, 0.5)',
                            'rgba(255, 165, 2, 0.5)',
                            'rgba(255, 71, 87, 0.5)'
                        ],
                        borderColor: [
                            'rgba(0, 208, 132, 1)',
                            'rgba(102, 126, 234, 1)',
                            'rgba(255, 165, 2, 1)',
                            'rgba(255, 71, 87, 1)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#a0a8c9'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0a8c9',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        console.log('‚úÖ NutriScan Pro initialized!');
        console.log('üåç Database: 2.8M+ products (OpenFoodFacts)');
        console.log('üí∞ 100% FREE - No API costs!');
    </script>
</body>
</html>
